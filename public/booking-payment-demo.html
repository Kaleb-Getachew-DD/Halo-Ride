<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Booking + Payment Demo</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; }
        .container { max-width: 400px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        label { display: block; margin-top: 12px; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-top: 18px; padding: 10px 20px; background: #1e90ff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #156fc1; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
        pre { background: #eee; padding: 10px; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h2>Booking + Payment Demo</h2>
    <form id="loginForm">
        <h3>Login</h3>
        <label>Username or Phone
            <input type="text" name="username" required autocomplete="username">
        </label>
        <label>Password
            <input type="password" name="password" required autocomplete="current-password">
        </label>
        <button type="submit">Login</button>
        <div class="error" id="loginError"></div>
        <div class="success" id="loginSuccess"></div>
    </form>
    <form id="bookingForm" class="hidden">
        <h3>Book a Room</h3>
        <label>Hotel ID
            <input type="number" name="hotel_id" required>
        </label>
        <label>Room Type
            <input type="text" name="room_type" required>
        </label>
        <label>Check-in Date
            <input type="date" name="check_in_date" required>
        </label>
        <label>Check-out Date
            <input type="date" name="check_out_date" required>
        </label>
        <label>Number of Guests
            <input type="number" name="number_of_guests" min="1" required>
        </label>
        <label>Payment Method
            <select name="payment_method">
                <option value="chapa">Chapa</option>
                <option value="cash">Cash</option>
            </select>
        </label>
        <button type="submit">Book Now</button>
        <div class="error" id="bookingError"></div>
        <div class="success" id="bookingSuccess"></div>
        <pre id="bookingResponse" style="display:none;"></pre>
    </form>
    <!-- Remove payment form from HTML -->
</div>
<script>
    // After successful login, fetch user info and store in localStorage
    async function fetchAndStoreUserInfo() {
        try {
            const res = await fetch('/api/me', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwt_token'),
                    'Accept': 'application/json'
                }
            });
            if (res.ok) {
                const user = await res.json();
                localStorage.setItem('user_info', JSON.stringify(user));
            }
        } catch (e) {}
    }
    // Show booking form if already logged in
    if (localStorage.getItem('jwt_token')) {
        showForm('bookingForm');
    }
    // Login handler
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        document.getElementById('loginError').textContent = '';
        document.getElementById('loginSuccess').textContent = '';
        const form = e.target;
        const username = form.username.value;
        const password = form.password.value;
        let loginUrl, loginBody;
        if (/^09|07/.test(username)) {
            loginUrl = '/api/login/customer';
            loginBody = { phone: username, password };
        } else {
            loginUrl = '/api/login';
            loginBody = { username, password };
        }
        try {
            const res = await fetch(loginUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(loginBody)
            });
            const result = await res.json();
            if (res.ok && result.success && result.token) {
                localStorage.setItem('jwt_token', result.token);
                document.getElementById('loginSuccess').textContent = 'Login successful!';
                await fetchAndStoreUserInfo();
                showForm('bookingForm');
            } else {
                document.getElementById('loginError').textContent = result.message || 'Login failed.';
            }
        } catch (err) {
            document.getElementById('loginError').textContent = 'Network or server error.';
        }
    });
    // Booking handler
    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        document.getElementById('bookingError').textContent = '';
        document.getElementById('bookingSuccess').textContent = '';
        document.getElementById('bookingResponse').style.display = 'none';
        const form = e.target;
        // Step 1: Create reservation
        const reservationData = {
            hotel_id: form.hotel_id.value,
            room_type: form.room_type.value,
            check_in_date: form.check_in_date.value,
            check_out_date: form.check_out_date.value,
            number_of_guests: form.number_of_guests.value
        };
        let reservationResult;
        try {
            const res = await fetch('/api/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
                },
                body: JSON.stringify(reservationData)
            });
            reservationResult = await res.json();
            if (!res.ok || !reservationResult.success) {
                document.getElementById('bookingError').textContent = reservationResult.message || 'Reservation failed.';
                document.getElementById('bookingResponse').textContent = JSON.stringify(reservationResult, null, 2);
                document.getElementById('bookingResponse').style.display = 'block';
                return;
            }
        } catch (err) {
            document.getElementById('bookingError').textContent = 'Network or server error (reservation).';
            return;
        }
        // Step 2: Create booking
        const reservation_id = reservationResult.reservation?.id;
        if (!reservation_id) {
            document.getElementById('bookingError').textContent = 'Reservation created but no reservation_id returned.';
            document.getElementById('bookingResponse').textContent = JSON.stringify(reservationResult, null, 2);
            document.getElementById('bookingResponse').style.display = 'block';
            return;
        }
        const bookingData = {
            reservation_id: reservation_id,
            payment_method: form.payment_method.value
        };
        let bookingResult;
        try {
            const res = await fetch('/api/bookings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
                },
                body: JSON.stringify(bookingData)
            });
            bookingResult = await res.json();
            if (!res.ok || !bookingResult.success) {
                document.getElementById('bookingError').textContent = bookingResult.message || 'Booking failed.';
                document.getElementById('bookingResponse').textContent = JSON.stringify(bookingResult, null, 2);
                document.getElementById('bookingResponse').style.display = 'block';
                return;
            }
        } catch (err) {
            document.getElementById('bookingError').textContent = 'Network or server error (booking).';
            return;
        }
        document.getElementById('bookingSuccess').textContent = 'Booking created successfully!';
        document.getElementById('bookingResponse').textContent = JSON.stringify(bookingResult, null, 2);
        document.getElementById('bookingResponse').style.display = 'block';
        // Immediately initialize payment using user info and redirect to Chapa
        const user = JSON.parse(localStorage.getItem('user_info') || '{}');
        const payment = bookingResult.data.payment;
        if (payment && payment.success && payment.checkout_url) {
            document.getElementById('bookingSuccess').textContent = 'Redirecting to Chapa payment...';
            setTimeout(() => {
                window.location.href = payment.checkout_url;
            }, 1200);
            return;
        } else {
            document.getElementById('bookingError').textContent = payment && payment.message ? payment.message : 'Payment initialization failed.';
        }
    });
    // When showing payment form, auto-fill user info if available
    function autofillPaymentForm() {
        const user = JSON.parse(localStorage.getItem('user_info') || '{}');
        if (user && user.data) {
            const form = document.getElementById('paymentForm');
            const [firstName, ...lastNameParts] = (user.data.full_name || '').split(' ');
            form.first_name.value = firstName || '';
            form.last_name.value = lastNameParts.join(' ') || '';
            form.email.value = user.data.email || '';
            form.phone_number.value = user.data.phone || '';
        }
    }
    function showForm(id) {
        const forms = ['loginForm', 'bookingForm', 'paymentForm'];
        forms.forEach(formId => {
            const el = document.getElementById(formId);
            if (el) el.classList.add('hidden');
        });
        const showEl = document.getElementById(id);
        if (showEl) showEl.classList.remove('hidden');
        if (id === 'paymentForm') autofillPaymentForm();
    }
</script>
</body>
</html> 